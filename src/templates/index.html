<!DOCTYPE html>
<html>
<head>
    <title>UNav</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }
        .top-section {
            display: flex;
            flex: 1;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .left-side, .right-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .left-side {
            border-right: 2px solid #ddd;
            padding-right: 10px;
        }
        .right-side {
            padding-left: 10px;
        }
        .button-container {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .button-container button, .button-container input {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #query_image_preview, #floorplan_preview {
            width: 640px; /* Default larger size */
            height: 360px;
            border: 1px solid #ddd;
            object-fit: cover;
        }
        .bottom-section {
            display: flex;
            flex-direction: column;
            flex: 0 0 300px;
            overflow-y: auto;
            border-top: 2px solid #ddd;
            padding-top: 10px;
        }
        #server_output {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }
        #pose_output, #destination_output, #path_output {
            margin-top: 10px;
            font-size: 16px;
            padding: 5px;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            position: absolute;
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            overflow: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .canvas-container {
            overflow: scroll;
            max-height: 500px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
        #floorplan_canvas {
            margin-top: 10px;
        }
        .folder-content {
            max-height: 200px;
            overflow-y: auto;
            margin-left: 20px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
</head>
<body>
    <h1>UNav</h1>
    <div class="container">
        <div class="top-section">
            <div class="left-side">
                <div class="button-container">
                    <button onclick="openSettings()">Settings</button>
                    <button onclick="startServer()">Start Server</button>
                    <button onclick="terminateServer()">Terminate Server</button>
                </div>
                <div class="button-container">
                    <button onclick="openImageBrowser()">Browse Query Image</button>
                </div>
                <img id="query_image_preview" src="" alt="Selected Image Preview"/>
            </div>
            <div class="right-side">
                <div class="button-container">
                    <button onclick="localize()">Localize</button>
                    <button onclick="openSelectDestination()">Select Destination</button>
                    <button onclick="navigate()">Navigate</button>
                </div>
                <canvas id="floorplan_preview"></canvas>
                <div id="pose_output">Pose: </div>
                <div id="destination_output">Selected Destination: </div>
                <div id="path_output">Path: </div>
            </div>
        </div>
        <div class="bottom-section">
            <div id="server_output"></div>
        </div>
    </div>

    <!-- The Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettings()">&times;</span>
            <h2>Settings</h2>
            <form id="settingsForm">
                <div class="form-group">
                    <label for="place">Place</label>
                    <input type="text" id="place" name="place" value="New_York_City">
                </div>
                <div class="form-group">
                    <label for="building">Building</label>
                    <input type="text" id="building" name="building" value="LightHouse">
                </div>
                <div class="form-group">
                    <label for="floor">Floor</label>
                    <input type="text" id="floor" name="floor" value="6th_floor">
                </div>
                <div class="form-group">
                    <label for="scale">Scale</label>
                    <input type="number" id="scale" name="scale" value="0.01098358101" step="0.00000000001">
                </div>
                <button type="button" onclick="submitSettings()">Submit</button>
            </form>
        </div>
    </div>

    <!-- The Select Destination Modal -->
    <div id="selectDestinationModal" class="modal">
        <div class="modal-content" id="selectDestinationModalContent">
            <span class="close" onclick="closeSelectDestination()">&times;</span>
            <h2>Select Destination</h2>
            <div class="canvas-container">
                <canvas id="floorplan_canvas"></canvas>
            </div>
            <button onclick="submitDestination()">Submit</button>
        </div>
    </div>

    <!-- The Image Browser Modal -->
    <div id="imageBrowserModal" class="modal">
        <div class="modal-content" id="imageBrowserModalContent">
            <span class="close" onclick="closeImageBrowser()">&times;</span>
            <h2>Browse Query Image</h2>
            <div id="image_browser"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let selectedImageBase64 = null;
        let selectedDestination = null;
        let currentPose = null;

        socket.on('log', function(msg) {
            document.getElementById('server_output').innerHTML += `<p>${msg.data}</p>`;
            document.getElementById('server_output').scrollTop = document.getElementById('server_output').scrollHeight;
        });

        function openSettings() {
            document.getElementById('settingsModal').style.display = "block";
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = "none";
        }

        function openImageBrowser() {
            fetch('/list_images', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                const imageBrowser = document.getElementById('image_browser');
                imageBrowser.innerHTML = '';

                // Sort folders
                const sortedFolders = Object.keys(data).sort();

                sortedFolders.forEach(id => {
                    const idDiv = document.createElement('div');
                    idDiv.innerHTML = `<strong>${id}</strong> <span class="folder-toggle">[+]</span>`;
                    idDiv.style.cursor = 'pointer';
                    idDiv.onclick = function() {
                        const imagesDiv = document.getElementById(`images_${id}`);
                        const toggleSpan = idDiv.querySelector('.folder-toggle');
                        if (imagesDiv.style.display === 'none') {
                            imagesDiv.style.display = 'block';
                            toggleSpan.innerText = '[-]';
                        } else {
                            imagesDiv.style.display = 'none';
                            toggleSpan.innerText = '[+]';
                        }
                    };
                    
                    const imagesDiv = document.createElement('div');
                    imagesDiv.id = `images_${id}`;
                    imagesDiv.style.display = 'none';
                    imagesDiv.className = 'folder-content'; // Add class for styling

                    // Sort images
                    const sortedImages = data[id].sort();
                    sortedImages.forEach(imageName => {
                        const imageLink = document.createElement('a');
                        imageLink.href = '#';
                        imageLink.innerText = imageName;
                        imageLink.onclick = () => selectImage(id, imageName);
                        imagesDiv.appendChild(document.createElement('br'));
                        imagesDiv.appendChild(imageLink);
                    });

                    idDiv.appendChild(imagesDiv);
                    imageBrowser.appendChild(idDiv);
                });

                document.getElementById('imageBrowserModal').style.display = "block";
            });
        }

        function closeImageBrowser() {
            document.getElementById('imageBrowserModal').style.display = "none";
        }

        function selectImage(id, imageName) {
            fetch(`/get_image/${id}/${imageName}`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                selectedImageBase64 = data.image;
                document.getElementById('query_image_preview').src = `data:image/png;base64,${selectedImageBase64}`;
                initializeOutputs();
                drawFloorplanPreview(); // Reset floorplan preview with destination candidates
                closeImageBrowser();
            });
        }

        function initializeOutputs() {
            document.getElementById('pose_output').innerText = 'Pose: ';
            document.getElementById('destination_output').innerText = 'Selected Destination: ';
            document.getElementById('path_output').innerText = 'Path: ';
        }

        function openSelectDestination() {
            fetch('/get_floorplan_and_destinations', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                socket.emit('log', {data: `Destination data fetched`});
                drawFloorplan(data.floorplan, data.destinations, data.anchors);
                document.getElementById('selectDestinationModal').style.display = "block";
            });
        }

        function closeSelectDestination() {
            document.getElementById('selectDestinationModal').style.display = "none";
        }

        function submitSettings() {
            const form = document.getElementById('settingsForm');
            const formData = new FormData(form);
            const settings = {};
            formData.forEach((value, key) => {
                settings[key] = isNaN(value) ? value : parseFloat(value);
            });
            fetch('/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                socket.emit('log', {data: `Settings updated: ${JSON.stringify(data)}`});
                closeSettings();
            });
        }

        function startServer() {
            fetch('/start', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                socket.emit('log', {data: `Server started: ${data.status}`});
                drawFloorplanPreview(); // Draw the floorplan with destinations when the server starts
            });
        }

        function terminateServer() {
            fetch('/terminate', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                socket.emit('log', {data: `Server terminated: ${data.status}`});
                resetState(); // Reset UI and state
            });
        }

        function resetState() {
            // Clear variables
            selectedImageBase64 = null;
            selectedDestination = null;
            currentPose = null;
            
            // Clear UI elements
            document.getElementById('query_image_preview').src = "";
            document.getElementById('pose_output').innerText = 'Pose: ';
            document.getElementById('destination_output').innerText = 'Selected Destination: ';
            document.getElementById('path_output').innerText = 'Path: ';
            document.getElementById('server_output').innerHTML = "";
            
            // Clear canvas
            const canvas = document.getElementById('floorplan_preview');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function localize() {
            fetch('/localize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query_image: selectedImageBase64 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.pose) {
                    console.log(data);
                    const roundedPose = data.pose.map(coord => Math.round(coord));
                    document.getElementById('pose_output').innerText = `Pose: ${JSON.stringify(roundedPose)}`;
                    socket.emit('log', {data: `Pose: ${JSON.stringify(roundedPose)}`});
                    currentPose = roundedPose;
                    drawFloorplanPreview(currentPose, selectedDestination); // Draw the floorplan with pose and selected destination
                } else {
                    document.getElementById('pose_output').innerText = `Pose: Localization failed`;
                    socket.emit('log', {data: `Pose: Localization failed`});
                }
            })
            .catch(error => {
                document.getElementById('pose_output').innerText = `Pose: Localization failed`;
                socket.emit('log', {data: `Pose: Localization failed`});
                console.error("Localization error:", error);  // Debug log
            });
        }


        function drawFloorplan(floorplan, destinations, anchors) {
            const canvas = document.getElementById('floorplan_canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.src = `data:image/png;base64,${floorplan}`;
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);
                drawDestinations(ctx, destinations);
                if (currentPose) {
                    drawPose(ctx, currentPose);
                }
            };

            canvas.onclick = function(event) {
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                const closestDestination = destinations.reduce((prev, curr) => {
                    const prevDistance = Math.hypot(prev.location[0] - x, prev.location[1] - y);
                    const currDistance = Math.hypot(curr.location[0] - x, curr.location[1] - y);
                    return prevDistance < currDistance ? prev : curr;
                });
                selectedDestination = closestDestination;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, img.width, img.height);
                drawDestinations(ctx, destinations);
                if (currentPose) {
                    drawPose(ctx, currentPose);
                }
                ctx.beginPath();
                ctx.arc(closestDestination.location[0], closestDestination.location[1], 10, 0, 2 * Math.PI);
                ctx.fillStyle = 'green';
                ctx.fill();
                document.getElementById('destination_output').innerText = `Selected Destination: ${selectedDestination.name}`;
                document.getElementById('path_output').innerText = ''; // Clear previous path output
            };
        }

        function drawFloorplanPreview(pose, destination) {
            fetch('/get_floorplan_and_destinations', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                const canvas = document.getElementById('floorplan_preview');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.src = `data:image/png;base64,${data.floorplan}`;
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    if (destination) {
                        drawSelectedDestination(ctx, destination);
                    } else {
                        drawDestinations(ctx, data.destinations);
                    }
                    if (pose) {
                        drawPose(ctx, pose);
                    }
                };
            });
        }

        function drawDestinations(ctx, destinations) {
            ctx.fillStyle = 'red';
            ctx.font = '12px Arial';
            destinations.forEach((dest, idx) => {
                ctx.beginPath();
                ctx.arc(dest.location[0], dest.location[1], 5, 0, 2 * Math.PI);
                ctx.fill();
                ctx.fillText(`${idx}: ${dest.name}`, dest.location[0], dest.location[1]);
            });
        }

        function drawSelectedDestination(ctx, destination) {
            ctx.fillStyle = 'red'; // Change color to star
            ctx.font = '100px Arial';
            ctx.beginPath();
            ctx.moveTo(destination.location[0], destination.location[1] - 100);
            ctx.lineTo(destination.location[0] + 50, destination.location[1] + 50);
            ctx.lineTo(destination.location[0] - 100, destination.location[1] - 20);
            ctx.lineTo(destination.location[0] + 100, destination.location[1] - 20);
            ctx.lineTo(destination.location[0] - 50, destination.location[1] + 50);
            ctx.closePath();
            ctx.fill();
            ctx.fillText(destination.name, destination.location[0], destination.location[1]);
        }

        function drawPose(ctx, pose) {
            const x = pose[0];
            const y = pose[1];
            const angle = pose[2];
            const length = 200; // Increase length

            const x1 = x - length * Math.sin(angle / 180 * Math.PI);
            const y1 = y - length * Math.cos(angle / 180 * Math.PI);

            ctx.fillStyle = 'blue';
            ctx.beginPath();
            ctx.arc(x, y, 70, 0, 2 * Math.PI);
            ctx.fill();

            ctx.strokeStyle = 'blue';
            ctx.lineWidth = 40; 
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x1, y1);
            ctx.stroke();
        }

        function submitDestination() {
            if (selectedDestination) {
                fetch('/select_destination', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({destination_id: selectedDestination.id})
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    socket.emit('log', {data: `Destination selected: ${JSON.stringify(selectedDestination.name)}`});
                    drawFloorplanPreview(currentPose, selectedDestination); // Draw floorplan with selected destination
                    closeSelectDestination();
                });
            } else {
                alert('Please select a destination');
            }
        }

        function navigate() {
            fetch('/planner', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                const canvas = document.getElementById('floorplan_preview');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.src = `data:image/png;base64,${data.floorplan}`;
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    drawTrajectory(ctx, data.paths);
                };

                if (data.paths.length <= 1) {
                    document.getElementById('path_output').innerText = `Path: Way to destination is blocked`;
                } else {
                    // Display the path list under Selected Destination
                    const pathList = data.paths.map(path => {
                        const x = Math.round(path[0]);
                        const y = Math.round(path[1]);
                        const floor = path.length > 2 ? path[2] : '';
                        return `(${x}, ${y}${floor ? `, ${floor}` : ''})`;
                    }).join('<br>');
                    document.getElementById('path_output').innerHTML = `Path:<br>${pathList}`;
                }
            })
            .catch(error => {
                console.error("Error in navigate:", error);  // Debug log
            });
        }

        function drawTrajectory(ctx, paths) {
            for (let i = 1; i < paths.length; i++) {
                const x0 = paths[i - 1][0];
                const y0 = paths[i - 1][1];
                const x1 = paths[i][0];
                const y1 = paths[i][1];

                ctx.strokeStyle = 'green';
                ctx.lineWidth = 40; 
                ctx.beginPath();
                ctx.moveTo(x0, y0);
                ctx.lineTo(x1, y1);
                ctx.stroke();
            }

            const start_x = paths[0][0];
            const start_y = paths[0][1];
            ctx.fillStyle = 'blue';
            ctx.beginPath();
            ctx.arc(start_x, start_y, 70, 0, 2 * Math.PI);
            ctx.fill();

            const end_x = paths[paths.length - 1][0];
            const end_y = paths[paths.length - 1][1];

            ctx.fillStyle = 'red'; // Change color to star
            ctx.beginPath();
            ctx.moveTo(end_x, end_y - 100);
            ctx.lineTo(end_x + 50, end_y + 50);
            ctx.lineTo(end_x - 100, end_y - 20);
            ctx.lineTo(end_x + 100, end_y - 20);
            ctx.lineTo(end_x - 50, end_y + 50);
            ctx.closePath();
            ctx.fill();
        }

        window.onclick = function(event) {
            const modalSettings = document.getElementById('settingsModal');
            const modalDestination = document.getElementById('selectDestinationModal');
            const modalImageBrowser = document.getElementById('imageBrowserModal');
            if (event.target === modalSettings) {
                modalSettings.style.display = "none";
            }
            if (event.target === modalDestination) {
                modalDestination.style.display = "none";
            }
            if (event.target === modalImageBrowser) {
                modalImageBrowser.style.display = "none";
            }
        }
    </script>
</body>
</html>
